<!DOCTYPE html>
<html>
<head>
    <title>SparkChat - Fixed Messaging</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; }
        #chat-box { height: 300px; border: 1px solid #ddd; padding: 10px; overflow-y: scroll; margin-bottom: 10px; }
        #message-input { width: 70%; padding: 8px; }
        button { padding: 8px 15px; background: #6c5ce7; color: white; border: none; cursor: pointer; }
        .status { color: #666; font-size: 0.9em; margin-top: 10px; }
        .message { margin: 5px 0; }
        .you { color: #6c5ce7; }
        .stranger { color: #d63031; }
        .system { color: #0984e3; }
    </style>
</head>
<body>
    <h1>âœ¨ SparkChat</h1>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
        <button id="send-btn" disabled>Send</button>
    </div>
    <button id="start-btn">Start Chat</button>
    <div class="status" id="status">Disconnected</div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // DOM elements
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const startBtn = document.getElementById('start-btn');
        const statusEl = document.getElementById('status');

        // Connection variables
        let peer;
        let conn;
        let roomId = window.location.hash.substring(1) || generateRoomId();

        // Generate simple room ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 6);
        }

        // Initialize PeerJS connection
        function initPeerConnection() {
            peer = new Peer({
                config: { 
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478?transport=udp' }
                    ]
                }
            });

            peer.on('open', (id) => {
                updateStatus(`Connected as ${id.substring(0, 5)}...`);
                
                if (window.location.hash) {
                    // User B - connect to initiator
                    connectToPeer(roomId);
                } else {
                    // User A - wait for connection
                    window.location.hash = roomId;
                    updateStatus(`Share this link: ${window.location.href}`);
                    peer.on('connection', (connection) => {
                        setupConnection(connection);
                    });
                }
            });

            peer.on('error', (err) => {
                updateStatus(`Error: ${err.type}`);
            });
        }

        // Connect to another peer
        function connectToPeer(targetId) {
            conn = peer.connect(targetId, {
                reliable: true,
                serialization: 'json'
            });
            setupConnection(conn);
        }

        // Set up connection events
        function setupConnection(connection) {
            conn = connection;
            
            conn.on('open', () => {
                updateStatus("Connected to stranger!");
                sendBtn.disabled = false;
                messageInput.focus();
                addMessage("System: You're now connected!", 'system');
            });

            conn.on('data', (data) => {
                addMessage(`Stranger: ${data}`, 'stranger');
            });

            conn.on('close', () => {
                updateStatus("Connection closed");
                sendBtn.disabled = true;
                addMessage("System: Stranger disconnected", 'system');
            });
            
            conn.on('error', (err) => {
                updateStatus(`Connection error: ${err}`);
            });
        }

        // Send message function
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && conn && conn.open) {
                try {
                    conn.send(message);
                    addMessage(`You: ${message}`, 'you');
                    messageInput.value = '';
                } catch (err) {
                    updateStatus(`Failed to send: ${err}`);
                }
            }
        }

        // UI Helpers
        function addMessage(text, type = 'you') {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateStatus(text) {
            statusEl.textContent = text;
        }

        // Event Listeners
        startBtn.addEventListener('click', () => {
            startBtn.disabled = true;
            initPeerConnection();
        });

        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Auto-start if URL has hash (for User B)
        if (window.location.hash) {
            startBtn.click();
        }
    </script>
</body>
</html>
